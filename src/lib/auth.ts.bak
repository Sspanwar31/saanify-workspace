'use client'

/**
 * ✅ Safe LocalStorage wrapper — no server errors
 */
const safeLocalStorage = {
  getItem: (key: string): string | null => {
    if (typeof window === 'undefined' || !window.localStorage) return null
    try {
      return window.localStorage.getItem(key)
    } catch (err) {
      console.error('localStorage.getItem failed:', err)
      return null
    }
  },
  setItem: (key: string, value: string) => {
    if (typeof window === 'undefined' || !window.localStorage) return
    try {
      window.localStorage.setItem(key, value)
    } catch (err) {
      console.error('localStorage.setItem failed:', err)
    }
  },
  removeItem: (key: string) => {
    if (typeof window === 'undefined' || !window.localStorage) return
    try {
      window.localStorage.removeItem(key)
    } catch (err) {
      console.error('localStorage.removeItem failed:', err)
    }
  },
}

// ----------------------------

export interface AuthTokens {
  accessToken: string
  refreshToken: string
}

export interface UserInfo {
  id: string
  email: string
  name?: string
  role: 'SUPER_ADMIN' | 'CLIENT'
  societyAccountId?: string
}

// ✅ Write cookies safely (client-only)
export const setAuthTokens = (tokens: AuthTokens) => {
  if (typeof document === 'undefined') return

  document.cookie = `auth-token=${tokens.accessToken}; path=/; max-age=900; samesite=lax`
  document.cookie = `refresh-token=${tokens.refreshToken}; path=/; max-age=604800; samesite=lax`

  safeLocalStorage.setItem('refresh-token', tokens.refreshToken)
}

// ✅ Read cookies safely
export const getAccessToken = () => {
  if (typeof document === 'undefined') return null
  const cookies = document.cookie.split(';')
  const authCookie = cookies.find(c => c.trim().startsWith('auth-token='))
  return authCookie ? authCookie.split('=')[1] : null
}

export const getRefreshToken = () => {
  if (typeof document === 'undefined') return null
  const cookies = document.cookie.split(';')
  const refreshCookie = cookies.find(c => c.trim().startsWith('refresh-token='))
  if (refreshCookie) return refreshCookie.split('=')[1]

  return safeLocalStorage.getItem('refresh-token')
}

export const removeAuthTokens = () => {
  if (typeof document === 'undefined') return
  document.cookie = 'auth-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
  document.cookie = 'refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
  safeLocalStorage.removeItem('refresh-token')
}

// ✅ Refresh token safely
export const refreshAccessToken = async (): Promise<string | null> => {
  const refreshToken = getRefreshToken()
  if (!refreshToken) return null

  try {
    const res = await fetch('/api/auth/refresh', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refreshToken }),
    })

    if (!res.ok) throw new Error('Refresh failed')

    const data = await res.json()
    document.cookie = `auth-token=${data.accessToken}; path=/; max-age=900; samesite=lax`
    return data.accessToken
  } catch (err) {
    console.error('Token refresh failed:', err)
    removeAuthTokens()
    return null
  }
}

// ✅ API request helper
export const makeAuthenticatedRequest = async (url: string, options: RequestInit = {}) => {
  let token = getAccessToken()
  if (!token) token = await refreshAccessToken()
  if (!token) throw new Error('No valid auth token')

  const res = await fetch(url, {
    ...options,
    headers: { ...options.headers, Authorization: `Bearer ${token}` },
  })

  if (res.status === 401) {
    const newToken = await refreshAccessToken()
    if (!newToken) throw new Error('Re-auth failed')
    return fetch(url, {
      ...options,
      headers: { ...options.headers, Authorization: `Bearer ${newToken}` },
    })
  }

  return res
}

export const checkSession = async (): Promise<{ authenticated: boolean; user?: UserInfo }> => {
  try {
    const token = getAccessToken()
    const res = await fetch('/api/auth/check-session', {
      headers: token ? { Authorization: `Bearer ${token}` } : {},
    })
    const data = await res.json()
    if (data.authenticated && data.user) return { authenticated: true, user: data.user }
    removeAuthTokens()
    return { authenticated: false }
  } catch (err) {
    console.error('Session check failed:', err)
    removeAuthTokens()
    return { authenticated: false }
  }
}

export const logout = async () => {
  try {
    await fetch('/api/auth/logout', { method: 'POST' })
  } catch {}
  removeAuthTokens()
  if (typeof window !== 'undefined') window.location.href = '/'
}
